## D-001 — Introduction of SQL Persistence

### Purpose

To replace Fake persistence (as authorized by **D-000**) with **real SQL-backed persistence**, while preserving **all established invariants, tests, and semantics**.

This directive governs *how* persistence is introduced — not *what* the system does.

---

### Authority

This directive is subordinate to:

* **D-000 — Fake Persistence as Scaffolding**
* All existing **invariants (I-001 … I-020)**

No directive may weaken, bypass, or reinterpret existing invariants.

---

### Directive

#### 1. Persistence Backend Replacement

* Fake persistence implementations (`FakePersonStore`, `FakeAddressStore`) MUST be replaced with SQL-backed persistence.
* Replacement MUST be done incrementally and explicitly.
* At no point may Fake and real persistence be mixed ambiguously.

---

#### 2. Invariants Remain Authoritative

* All existing invariant tests MUST pass unchanged in meaning.
* Tests MAY change:

  * wiring
  * setup / teardown
  * backend instantiation
* Tests MUST NOT change:

  * assertions
  * semantic expectations
  * failure modes

If a test cannot pass under real persistence:

* a missing invariant has been discovered, or
* the persistence implementation is incorrect.

---

#### 3. Explicit Persistence Layer Introduction

* SQL persistence MUST be introduced via a **dedicated persistence layer**.
* Domain entities (`Person`, `Address`) MUST remain persistence-agnostic.
* No ORM artifacts may leak into domain models.

---

#### 4. ORM Constraints

* SQLAlchemy is the approved ORM.
* SQLAlchemy 2.x semantics are mandatory (>=2.0,<3.0).
* Raw SQL is forbidden.
* ORM models MAY differ structurally from domain models.
* Mapping between ORM models and domain entities MUST be explicit.

(Consistent with policies P-05 and P-06.)

---

#### 5. Session and Transaction Scope

* Persistence sessions MUST be explicit and operation-scoped.
* No global or long-lived sessions are allowed.
* Each CRUD operation defines its own transactional boundary.

---

#### 6. Replacement Strategy (Scaffolding Removal)

* Fake persistence MUST be retired once:

  * all invariant tests pass against SQL
  * no Fake-only behavior remains relied upon
* Fake code SHOULD then be deleted, not abstracted.

This is intentional disposal, not refactoring.

---

### Non-Goals

This directive does NOT:

* introduce new invariants
* change domain semantics
* define performance characteristics
* define migration strategy
* define concurrency guarantees
* define API or UI behavior

Those concerns require separate directives.

---

### Rationale

Per **D-000**, Fake persistence existed to allow:

* invariant discovery
* lifecycle reasoning
* operation semantics
* executable tests without infrastructure cost

D-001 marks the transition point where:

* semantics are frozen
* invariants are complete enough to harden
* infrastructure may now safely encode meaning

The system graduates from **semantic discovery** to **semantic preservation**.

---

### Success Criteria

D-001 is satisfied when:

* all invariant tests pass against SQL-backed persistence
* Fake persistence can be fully removed
* no invariant or test meaning was altered
* persistence decisions remain inspectable and reversible
