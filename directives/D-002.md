## **D-002 — Switch Test Authority from Fake Persistence to SQL Persistence**

### Directive Type

**Authority Shift Directive**

---

## **Purpose**

This directive formally transfers **test authority** from Fake (in-memory) persistence to **SQL-backed persistence**, making SQL the **authoritative execution substrate** for all invariant enforcement.

This is a **semantic transition**, not a feature addition.

After D-002, **Fake persistence is no longer authoritative** and may only exist as a legacy scaffold, reference implementation, or be removed.

---

## **Why This Directive Exists**

Until now:

* Fake persistence was authoritative
* SQL persistence was:

  * parallel
  * non-authoritative
  * untested by invariants

This separation was **intentional** to allow:

* invariant discovery
* lifecycle reasoning
* monotone construction of behavior

D-002 marks the point where:

> **“What passes the tests is now what runs on SQL.”**

This is the **first irreversible commitment** to a concrete persistence technology.

---

## **Scope of Authority Change**

This directive affects:

* **All invariants I-001 through I-020**
* **All CRUD operations** for:

  * `Person`
  * `Address`
* **All lifecycle semantics**, including:

  * update
  * delete
  * cascade behavior
  * irreversibility

This directive does **not** introduce new invariants.

---

## **What Changes**

### Before D-002

* Tests use:

  * `FakePersonStore`
  * `FakeAddressStore`
* SQL repositories exist but are:

  * untested
  * non-authoritative

### After D-002

* Tests MUST:

  * execute against SQL-backed repositories
  * exercise real database behavior
* SQL persistence becomes:

  * authoritative
  * invariant-enforcing via tests

Fake persistence becomes:

* deprecated
* optional
* removable

---

## **What Does NOT Change**

This directive does **not**:

* Change invariant definitions
* Add new behaviors
* Introduce new APIs
* Change domain models
* Change lifecycle semantics
* Add performance guarantees
* Add concurrency semantics

This is a **binding operation**, not an expansion.

---

## **Required Properties of the Transition**

The transition MUST be:

1. **Explicit**

   * No hidden switches
   * No environment-variable magic
   * No silent fallbacks

2. **Monotone**

   * No invariant is weakened
   * No test is deleted to “make SQL pass”

3. **Reversible (temporarily)**

   * Fake persistence may be retained briefly
   * Rollback must be possible if SQL fails invariants

4. **Auditable**

   * Ledger MUST record:

     * when authority shifted
     * which tests were affected
     * which repositories became authoritative

---

## **Constraints**

* SQLAlchemy version: **>= 2.0, < 3.0**
* SQLite MAY be used initially
* No new persistence abstractions
* No dual-write or shadow persistence
* No partial authority (SQL is either authoritative or not)

---

## **Validation Standard**

D-002 is considered **complete** when:

1. All invariant tests run against SQL-backed repositories
2. All invariants pass **unchanged**
3. Fake repositories are no longer referenced by tests
4. No behavior divergence is tolerated
5. Ledger records the authority shift

If any invariant fails under SQL:

> **The failure is authoritative.**
> The SQL implementation must be corrected — not the invariant.

---

## **Non-Goals**

D-002 explicitly does NOT:

* Optimize SQL queries
* Introduce migrations
* Add transactions beyond existing semantics
* Add concurrency controls
* Add performance tests
* Remove Fake persistence immediately

Those are **post-authority** concerns.

---

## **Consequences (Explicit)**

After D-002:

* SQL is **no longer experimental**
* Bugs in SQL persistence are **real bugs**
* Fake persistence loses authority
* Invariants become **executable guarantees** on real storage

This is the moment where:

> *“The model stops being hypothetical.”*

---

## **Follow-on Work (Out of Scope)**

Likely future directives:

* D-003 — Remove Fake Persistence
* D-004 — Introduce Migration Strategy
* D-005 — Add Transaction Semantics
* D-006 — Add Concurrency / Locking

None of these are implied by D-002.

