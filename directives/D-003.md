# **D-003 — Persistence Hardening (Post-Authority)**

## **Directive Type**

**Authority-Defense Directive**

---

## **Purpose**

To **defend, freeze, and make explicit** the semantics that became authoritative under **D-002**, ensuring that SQL-backed persistence remains:

* semantically stable
* resistant to accidental refactors
* immune to “cleanup-driven” semantic drift

This directive introduces **no new behavior**.
It exists to **lock in intent**, not to extend capability.

---

## **Authority and Precedence**

This directive:

* Builds on:

  * **D-000 — Fake Persistence as Scaffolding**
  * **D-001 — Introduction of SQL Persistence**
  * **D-002 — Switch Test Authority from Fake → SQL**
* Governs:

  * All SQL persistence behavior
  * All CRUD lifecycle semantics for `Person` and `Address`
* Is subordinate to:

  * Invariants **I-001 through I-020**

No part of this directive may weaken, reinterpret, or bypass any invariant.

---

## **Scope**

### Included

* Persistence-layer semantics
* Error behavior and failure modes
* Cascade and lifecycle mechanics
* Transaction boundaries
* Non-obvious design decisions already encoded

### Explicitly Excluded

* New invariants
* Domain model changes
* API or UI behavior
* Migrations
* Concurrency semantics
* Performance optimization
* Additional backends

---

## **Core Rules**

### **1. SQL Semantics Are Frozen**

All persistence semantics observable through invariant tests are now **frozen**.

This includes (but is not limited to):

* create / read / update / delete behavior
* lifecycle closure and irreversibility
* cascade delete semantics
* tombstone behavior
* error conditions and failure modes

Any future change that alters observable behavior **must be introduced via a new directive and new invariants**.

---

### **2. Error Semantics Are Intentional**

Existing error behavior is considered **semantically meaningful**, even if heterogeneous.

Specifically:

* Distinctions between:

  * `ValueError`
  * `KeyError`
  * mixed or composite exceptions
    are **intentional unless explicitly changed by directive**.
* Error “cleanup” or normalization is forbidden unless:

  * invariants are expanded, and
  * behavior change is explicitly authorized.

Ambiguity is resolved in favor of **preserving current behavior**.

---

### **3. Cascade Authority Must Be Explicit**

If multiple mechanisms contribute to cascade behavior (e.g. SQL foreign-key cascade and repository-level logic):

* The system MUST clearly document which mechanism is authoritative.
* Redundant mechanisms MAY exist but MUST NOT diverge semantically.
* Removal or simplification of any cascade mechanism is forbidden unless:

  * invariants remain unchanged, and
  * authority is preserved.

This rule exists to prevent “harmless refactors” from breaking lifecycle semantics.

---

### **4. Transaction Boundaries Are Fixed**

Persistence operations MUST remain:

* explicitly scoped
* operation-local
* transaction-bounded

The following are forbidden:

* shared or global sessions
* ambient transactions
* implicit retries
* cross-operation coupling

This rule is defensive and does not introduce new guarantees.

---

### **5. Non-Obvious Design Choices Must Be Defended**

Design choices that appear accidental but are **semantically required** MUST be treated as fixed.

Examples include (non-exhaustive):

* ownership fields not being part of domain dataclass structure
* tombstone usage in presence of hard deletes
* identity semantics defined solely by `id`

Such choices MUST NOT be “cleaned up” without directive-level authorization.

---

### **6. Monotone Deletions Only**

Under D-003:

* Dead code MAY be deleted
* Redundant scaffolding MAY be removed
* Unused helpers MAY be eliminated

The following are forbidden:

* abstraction introduction
* generalization
* refactoring that changes intent
* preparation for future backends

Deletion is allowed only when **no semantic meaning is lost**.

---

## **Validation Standard**

D-003 is satisfied when:

1. All invariant tests **pass unchanged**
2. SQL persistence behavior is **explicitly defended**
3. Accidental refactors are structurally discouraged
4. Authority boundaries are clear in code and documentation
5. No new semantics were introduced

---

## **Non-Goals (Reaffirmed)**

This directive does **not**:

* Add features
* Add guarantees
* Improve performance
* Prepare for scale
* Enable concurrency
* Introduce migrations

Those require future directives.

---

## **Outcome**

After **D-003**:

* Persistence semantics are **explicit and defended**
* SQL behavior is **stable and reviewable**
* The system is resistant to semantic erosion
* Future work can proceed without ambiguity

This directive marks the transition from:

> **“SQL works”**
> to
> **“SQL must not accidentally change meaning.”**
